<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-v1.0 plugin-docs plugin-id-default docs-doc-id-rancher/cloud-provider">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">Harvester Cloud Provider | Harvester</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.harvesterhci.io/v1.0/rancher/cloud-provider"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="v1.0"><meta data-rh="true" name="docusaurus_tag" content="docs-default-v1.0"><meta data-rh="true" name="docsearch:version" content="v1.0"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-v1.0"><meta data-rh="true" property="og:title" content="Harvester Cloud Provider | Harvester"><meta data-rh="true" name="description" content="RKE1 and RKE2 clusters can be provisioned in Rancher using the built-in Harvester Node Driver. Harvester provides load balancer and cluster Persistent Storage support to the guest Kubernetes cluster."><meta data-rh="true" property="og:description" content="RKE1 and RKE2 clusters can be provisioned in Rancher using the built-in Harvester Node Driver. Harvester provides load balancer and cluster Persistent Storage support to the guest Kubernetes cluster."><meta data-rh="true" name="keywords" content="Harvester,harvester,RKE,rke,RKE2,rke2,Harvester Cloud Provider"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.harvesterhci.io/v1.0/rancher/cloud-provider"><link data-rh="true" rel="alternate" href="https://docs.harvesterhci.io/v1.0/rancher/cloud-provider" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.harvesterhci.io/zh/v1.0/rancher/cloud-provider" hreflang="zh"><link data-rh="true" rel="alternate" href="https://docs.harvesterhci.io/v1.0/rancher/cloud-provider" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://U7QCSJFCWR-dsn.algolia.net" crossorigin="anonymous"><link rel="preconnect" href="https://www.googletagmanager.com">
<script>window.dataLayer=window.dataLayer||[]</script>
<script>!function(e,t,a,n,g){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var m=t.getElementsByTagName(a)[0],r=t.createElement(a);r.async=!0,r.src="https://www.googletagmanager.com/gtm.js?id=GTM-57KS2MW",m.parentNode.insertBefore(r,m)}(window,document,"script","dataLayer")</script>


<link rel="search" type="application/opensearchdescription+xml" title="Harvester" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.831dbdae.css">
<link rel="preload" href="/assets/js/runtime~main.693e3b15.js" as="script">
<link rel="preload" href="/assets/js/main.d1ef793e.js" as="script">
</head>
<body class="navigation-with-keyboard">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-57KS2MW" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo_horizontal.svg" alt="Harvester Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo_horizontal.svg" alt="Harvester Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/v1.0/">v1.0</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/dev/rancher/cloud-provider">v1.2-dev</a></li><li><a class="dropdown__link" href="/v1.1/rancher/cloud-provider">v1.1</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/v1.0/rancher/cloud-provider">v1.0</a></li><li><a class="dropdown__link" href="/v0.3/rancher/cloud-provider">v0.3</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/v1.0/rancher/cloud-provider" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/zh/v1.0/rancher/cloud-provider" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh">简体中文</a></li></ul></div><a aria-current="page" class="navbar__item navbar__link navbar__docs navbar__link--active" href="/v1.0/">Docs</a><a href="https://www.suse.com/c/?s=harvester" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__blog">Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://harvesterhci.io/kb" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__kb">Knowledge Base<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/harvester/harvester" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__github btn btn-secondary icon-github">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/v1.0/">Harvester Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/v1.0/install/requirements">Installation</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/v1.0/airgap">Air Gapped Environment</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/v1.0/upgrade/automatic">Upgrade</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/v1.0/authentication">Authentication</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/v1.0/upload-image">Upload Images</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/v1.0/host/">Host Management</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/v1.0/vm/create-vm">VM Management</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/v1.0/networking/harvester-network">Networking</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/v1.0/monitoring/">Monitoring</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/v1.0/rancher/rancher-integration">Rancher Integration</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v1.0/rancher/rancher-integration">Rancher Integration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v1.0/rancher/virtualization-management">Virtualization Management</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/v1.0/rancher/node/node-driver">Harvester Node Driver</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/v1.0/rancher/cloud-provider">Harvester Cloud Provider</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v1.0/rancher/csi-driver">Harvester CSI Driver</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/v1.0/terraform/">Harvester Terraform Provider</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/v1.0/settings/">Settings</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/v1.0/troubleshooting/installation">Troubleshooting</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/v1.0/faq">FAQ</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div><div><b>Harvester</b> <b>v1.0</b> is EOL and this documentation is no longer actively maintained. For more details, refer to the <a href="https://www.suse.com/suse-harvester/support-matrix/all-supported-versions/"><b>SUSE support matrix</b></a>.</div></div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/v1.1/rancher/cloud-provider">latest version</a></b> (<!-- -->v1.1<!-- -->).</div></div><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Rancher Integration</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Harvester Cloud Provider</span><meta itemprop="position" content="2"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: v1.0</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Harvester Cloud Provider</h1></header><p><a href="/v1.0/rancher/node/rke1-cluster">RKE1</a> and <a href="/v1.0/rancher/node/rke2-cluster">RKE2</a> clusters can be provisioned in Rancher using the built-in Harvester Node Driver. Harvester provides <a href="#load-balancer-support">load balancer</a> and <a href="/v1.0/rancher/csi-driver">cluster Persistent Storage</a> support to the guest Kubernetes cluster.</p><p>In this page we will learn:</p><ul><li>How to deploy the Harvester cloud provider in both RKE1 and RKE2.</li><li>How to use the <a href="#load-balancer-support">Harvester load balancer</a>.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="deploying">Deploying<a href="#deploying" class="hash-link" aria-label="Direct link to Deploying" title="Direct link to Deploying">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a href="#prerequisites" class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites">​</a></h3><ul><li>The Kubernetes cluster is built on top of Harvester virtual machines.</li><li>The Harvester virtual machines run as guest Kubernetes nodes are in the same namespace.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="deploying-to-the-rke1-cluster-with-harvester-node-driver">Deploying to the RKE1 Cluster with Harvester Node Driver<a href="#deploying-to-the-rke1-cluster-with-harvester-node-driver" class="hash-link" aria-label="Direct link to Deploying to the RKE1 Cluster with Harvester Node Driver" title="Direct link to Deploying to the RKE1 Cluster with Harvester Node Driver">​</a></h3><p>When spinning up an RKE cluster using the Harvester node driver, you can perform two steps to deploy the <code>Harvester</code> cloud provider:</p><ul><li><p>Select <code>Harvester(Out-of-tree)</code> option.</p><p>  <img loading="lazy" src="/assets/images/rke-cloud-provider-8cf30f11940ab37bbda533f8ad2554b9.png" width="3066" height="436" class="img_ev3q"></p></li><li><p>Install <code>Harvester Cloud Provider</code> from the Rancher marketplace.</p><p>  <img loading="lazy" src="/assets/images/install-harvester-cloud-provider-fcca9c86ea1d2c7eedf824c9b0b5d63a.png" width="3480" height="886" class="img_ev3q"></p></li></ul><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>You should specify the <code>Cluster name</code>. The default value <code>kubernetes</code> will be set if no <code>Cluster name</code> is entered. The <code>Cluster name</code> is used to distinguish the ownership of the Harvester load balancers. </p></div></div><ul><li><p>Install Harvester csi driver from the Rancher marketplace if needed.</p><p>  <img loading="lazy" src="/assets/images/install-harvester-csi-driver-02e0ba91b02f08e31bf87a2d9df2afee.png" width="3468" height="850" class="img_ev3q"></p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="deploying-to-the-rke2-cluster-with-harvester-node-driver-experimental">Deploying to the RKE2 Cluster with Harvester Node Driver <!-- -->[Experimental]<a href="#deploying-to-the-rke2-cluster-with-harvester-node-driver-experimental" class="hash-link" aria-label="Direct link to deploying-to-the-rke2-cluster-with-harvester-node-driver-experimental" title="Direct link to deploying-to-the-rke2-cluster-with-harvester-node-driver-experimental">​</a></h3><p>When spinning up an RKE2 cluster using the Harvester node driver, select the <code>Harvester</code> cloud provider. The node driver will then help deploy both the CSI driver and CCM automatically.</p><p>  <img loading="lazy" src="/assets/images/rke2-cloud-provider-2d541c4c966ae1adf2f7c375ea1743ac.png" width="1669" height="315" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="deploying-to-the-k3s-cluster-with-harvester-node-driver-experimental">Deploying to the K3s Cluster with Harvester Node Driver <!-- -->[Experimental]<a href="#deploying-to-the-k3s-cluster-with-harvester-node-driver-experimental" class="hash-link" aria-label="Direct link to deploying-to-the-k3s-cluster-with-harvester-node-driver-experimental" title="Direct link to deploying-to-the-k3s-cluster-with-harvester-node-driver-experimental">​</a></h3><ul><li><p>Choose the Kubernetes version to be k3s and click the <code>Edit as YAML</code> button to config the K3s cluster YAML (For existing cluster, you can also click the <code>Edit YAML</code> button to update it):</p><p><img loading="lazy" src="/assets/images/edit-k3s-cluster-yaml-244d7967b0be178a714944ddc2d8c465.png" width="2249" height="601" class="img_ev3q"></p></li><li><p>Edit K3s cluster YAML.</p><ul><li>Set <code>disable-cloud-provider: true</code> to disable default k3s cloud provider.</li><li>Add <code>cloud-provider=external</code> to use harvester cloud provider.</li></ul><p><img loading="lazy" src="/assets/images/k3s-cluster-yaml-content-for-harvester-cloud-provider-2237fc21b54b0440297a3050fc4e5826.png" width="457" height="706" class="img_ev3q"></p></li><li><p><a href="https://github.com/harvester/cloud-provider-harvester/blob/master/deploy/generate_addon.sh" target="_blank" rel="noopener noreferrer">Generate addon configuration</a> and put it in K3s VMs <code>/etc/kubernetes/cloud-config</code>.</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-external-cloud-provider">Deploy external cloud provider<a href="#deploy-external-cloud-provider" class="hash-link" aria-label="Direct link to Deploy external cloud provider" title="Direct link to Deploy external cloud provider">​</a></h3><p>Deploying external cloud provider is similar for both RKE2 and K3s based clusters.</p><p>Once the in-tree cloud provider has been disabled by following the above steps, you can deploy the external cloud provider via:</p><p>  <img loading="lazy" src="/assets/images/external-cloud-provider-addon-c892cb3dec8e72bd9ef5117f55b6131d.png" width="1599" height="764" class="img_ev3q"></p><p>A sample additional manifest is as follows:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: helm.cattle.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: HelmChart</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: harvester-cloud-provider</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  targetNamespace: kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bootstrap: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  repo: https://charts.harvesterhci.io/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  chart: harvester-cloud-provider</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  version: 0.1.12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  helmVersion: v3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The cloud provider needs a kubeconfig file to work, a limited scoped one can be generated using the <code>generate_addon.sh</code> script available in the <a href="https://github.com/harvester/cloud-provider-harvester" target="_blank" rel="noopener noreferrer">harvester/cloud-provider-harvester</a> repo.</p><p><em>NOTE:</em> The script needs access to the harvester cluster kubeconfig to work. In addition the namespace needs to be the namespace in which the workload cluster will be created.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># depend on kubectl to operate the Harvester cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./deploy/generate_addon.sh &lt;serviceaccount name&gt; &lt;namespace&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The output will look as follows:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">(⎈ |local:default)➜  cloud-provider-harvester git:(master) ✗ ./deploy/generate_addon.sh harvester-cloud-provider default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Creating target directory to hold files in ./tmp/kube...done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Creating a service account in default namespace: harvester-cloud-provider</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">W0506 16:44:15.429068 3008674 helpers.go:598] --dry-run is deprecated and can be replaced with --dry-run=client.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">serviceaccount/harvester-cloud-provider configured</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Creating a role in default namespace: harvester-cloud-provider</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">role.rbac.authorization.k8s.io/harvester-cloud-provider unchanged</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Creating a rolebinding in default namespace: harvester-cloud-provider</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">W0506 16:44:23.798293 3008738 helpers.go:598] --dry-run is deprecated and can be replaced with --dry-run=client.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rolebinding.rbac.authorization.k8s.io/harvester-cloud-provider configured</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Getting secret of service account harvester-cloud-provider on default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Secret name: harvester-cloud-provider-token-5zkk9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Extracting ca.crt from secret...done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Getting user token from secret...done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Setting current context to: local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cluster name: local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Endpoint: https://HARVESTER_ENDPOINT/k8s/clusters/local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Preparing k8s-harvester-cloud-provider-default-conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Setting a cluster entry in kubeconfig...Cluster &quot;local&quot; set.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Setting token credentials entry in kubeconfig...User &quot;harvester-cloud-provider-default-local&quot; set.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Setting a context entry in kubeconfig...Context &quot;harvester-cloud-provider-default-local&quot; created.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Setting the current-context in the kubeconfig file...Switched to context &quot;harvester-cloud-provider-default-local&quot;.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">########## cloud config ############</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusters:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- cluster:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    certificate-authority-data: CACERT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server: https://HARVESTER-ENDPOINT/k8s/clusters/local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">contexts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- context:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cluster: local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    namespace: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    user: harvester-cloud-provider-default-local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: harvester-cloud-provider-default-local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">current-context: harvester-cloud-provider-default-local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">preferences: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">users:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- name: harvester-cloud-provider-default-local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  user:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    token: TOKEN</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This cloud-config file can now be injected via the <code>user-data</code> available in the <code>advanced options</code> for the nodepool.
<img loading="lazy" src="/assets/images/cloud-config-userdata-8f6db0afa2079998e6d0930ca7ace5a4.png" width="2069" height="497" class="img_ev3q"></p><p>With these settings in place a K3s / RKE2 cluster should provision successfully while using the external cloud provider.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="upgrade-cloud-provider">Upgrade Cloud Provider<a href="#upgrade-cloud-provider" class="hash-link" aria-label="Direct link to Upgrade Cloud Provider" title="Direct link to Upgrade Cloud Provider">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="upgrade-rke2">Upgrade RKE2<a href="#upgrade-rke2" class="hash-link" aria-label="Direct link to Upgrade RKE2" title="Direct link to Upgrade RKE2">​</a></h3><p>The cloud provider can be upgraded by upgrading the RKE2 version. You can upgrade the RKE2 cluster via the Rancher UI as follows:</p><ol><li>Click <strong>☰ &gt; Cluster Management</strong>.</li><li>Find the guest cluster that you want to upgrade and select ⋮ <strong>&gt; Edit Config</strong>.</li><li>Select <strong>Kubernetes Version</strong>.</li><li>Click <strong>Save</strong>.</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="upgrade-rkek3s">Upgrade RKE/K3s<a href="#upgrade-rkek3s" class="hash-link" aria-label="Direct link to Upgrade RKE/K3s" title="Direct link to Upgrade RKE/K3s">​</a></h3><p>RKE/K3s upgrade cloud provider via the Rancher UI, as follows:</p><ol><li>Click <strong>☰ &gt; RKE/K3s Cluster &gt; Apps &gt; Installed Apps</strong>.</li><li>Find the cloud provider chart and select ⋮ <strong>&gt; Edit/Upgrade</strong>.</li><li>Select <strong>Version</strong>.</li><li>Click <strong>Next &gt; Update</strong>.</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="load-balancer-support">Load Balancer Support<a href="#load-balancer-support" class="hash-link" aria-label="Direct link to Load Balancer Support" title="Direct link to Load Balancer Support">​</a></h2><p>After deploying the <code>Harvester Cloud provider</code>, you can use the Kubernetes <code>LoadBalancer</code> service to expose a microservice inside the guest cluster to the external world. When you create a Kubernetes <code>LoadBalancer</code> service, a Harvester load balancer is assigned to the service and you can edit it through the <code>Add-on Config</code> in the Rancher UI.</p><p>  <img loading="lazy" src="/assets/images/lb-svc-e475b5a9a67cfcd1f5d37c2d550fc917.png" width="3474" height="1174" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ipam">IPAM<a href="#ipam" class="hash-link" aria-label="Direct link to IPAM" title="Direct link to IPAM">​</a></h3><p>Harvester&#x27;s built-in load balancer supports both <code>pool</code> and <code>dhcp</code> modes. You can select the mode in the Rancher UI. Harvester adds the annotation <code>cloudprovider.harvesterhci.io/ipam</code> to the service behind.</p><ul><li><p>pool: You should configure an IP address pool in Harvester in advance. The Harvester LoadBalancer controller will allocate an IP address from the IP address pool for the load balancer.</p><p><img loading="lazy" src="/assets/images/vip-pool-d544f501f104efd9aa4dd3e9015efd9d.png" width="3482" height="932" class="img_ev3q"> </p></li><li><p>dhcp:  A DHCP server is required. The Harvester LoadBalancer controller will request an IP address from the DHCP server.</p></li></ul><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>It is not allowed to modify the IPAM mode. You need to create a new service if you want to modify the IPAM mode.</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="health-checks">Health Checks<a href="#health-checks" class="hash-link" aria-label="Direct link to Health Checks" title="Direct link to Health Checks">​</a></h3><p>The Harvester load balancer supports TCP health checks. You can specify the parameters in the Rancher UI if you enable the <code>Health Check</code> option.</p><p>  <img loading="lazy" src="/assets/images/health-check-530254bf13d824edd8587eac0d30016d.png" width="3024" height="1450" class="img_ev3q"></p><p>Alternatively, you can specify the parameters by adding annotations to the service manually. The following annotations are supported:</p><table><thead><tr><th align="left">Annotation Key</th><th align="left">Value Type</th><th align="left">Required</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left"><code>cloudprovider.harvesterhci.io/healthcheck-port</code></td><td align="left">string</td><td align="left">true</td><td align="left">Specifies the port. The prober will access the address composed of the backend server IP and the port.</td></tr><tr><td align="left"><code>cloudprovider.harvesterhci.io/healthcheck-success-threshold</code></td><td align="left">string</td><td align="left">false</td><td align="left">Specifies the health check success threshold. The default value is 1. The backend server will start forwarding traffic if the number of times the prober continuously detects an address successfully reaches the threshold.</td></tr><tr><td align="left"><code>cloudprovider.harvesterhci.io/healthcheck-failure-threshold</code></td><td align="left">string</td><td align="left">false</td><td align="left">Specifies the health check failure threshold. The default value is 3. The backend server will stop forwarding traffic if the number of health check failures reaches the threshold.</td></tr><tr><td align="left"><code>cloudprovider.harvesterhci.io/healthcheck-periodseconds</code></td><td align="left">string</td><td align="left">false</td><td align="left">Specifies the health check period. The default value is 5 seconds.</td></tr><tr><td align="left"><code>cloudprovider.harvesterhci.io/healthcheck-timeoutseconds</code></td><td align="left">string</td><td align="left">false</td><td align="left">Specifies the timeout of every health check. The default value is 3 seconds.</td></tr></tbody></table></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/harvester/docs/edit/main/versioned_docs/version-v1.0/rancher/cloud-provider.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2022-11-25T02:18:22.000Z">Nov 25, 2022</time></b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/v1.0/rancher/node/k3s-cluster"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Creating an K3s Kubernetes Cluster</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/v1.0/rancher/csi-driver"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Harvester CSI Driver</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#deploying" class="table-of-contents__link toc-highlight">Deploying</a><ul><li><a href="#prerequisites" class="table-of-contents__link toc-highlight">Prerequisites</a></li><li><a href="#deploying-to-the-rke1-cluster-with-harvester-node-driver" class="table-of-contents__link toc-highlight">Deploying to the RKE1 Cluster with Harvester Node Driver</a></li><li><a href="#deploying-to-the-rke2-cluster-with-harvester-node-driver-experimental" class="table-of-contents__link toc-highlight">Deploying to the RKE2 Cluster with Harvester Node Driver Experimental</a></li><li><a href="#deploying-to-the-k3s-cluster-with-harvester-node-driver-experimental" class="table-of-contents__link toc-highlight">Deploying to the K3s Cluster with Harvester Node Driver Experimental</a></li><li><a href="#deploy-external-cloud-provider" class="table-of-contents__link toc-highlight">Deploy external cloud provider</a></li></ul></li><li><a href="#upgrade-cloud-provider" class="table-of-contents__link toc-highlight">Upgrade Cloud Provider</a><ul><li><a href="#upgrade-rke2" class="table-of-contents__link toc-highlight">Upgrade RKE2</a></li><li><a href="#upgrade-rkek3s" class="table-of-contents__link toc-highlight">Upgrade RKE/K3s</a></li></ul></li><li><a href="#load-balancer-support" class="table-of-contents__link toc-highlight">Load Balancer Support</a><ul><li><a href="#ipam" class="table-of-contents__link toc-highlight">IPAM</a></li><li><a href="#health-checks" class="table-of-contents__link toc-highlight">Health Checks</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 harvesterhci.io</div></div></div></footer></div>
<script src="/assets/js/runtime~main.693e3b15.js"></script>
<script src="/assets/js/main.d1ef793e.js"></script>
</body>
</html>